name: PHP CodeSniffer Autofix

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  phpcs_autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: mbstring, xml, ctype, iconv, json
          tools: composer

      - name: Allow Composer plugins
        run: |
          composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer config --no-plugins allow-plugins.phpcompatibility/phpcs-compatinfo true
          # Add any other plugins if they cause issues

      - name: Install PHP_CodeSniffer and WordPress Coding Standards
        run: |
          composer require --dev squizlabs/php_codesniffer "*"
          composer require --dev wp-coding-standards/wpcs "*"
          composer require --dev phpcompatibility/phpcompatibility-wp "*"        

      - name: Run PHPCBF to fix coding standards
        run: vendor/bin/phpcbf --standard=phpcs.xml --extensions=php . || true

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Apply PHPCBF fixes"
          branch: ${{ github.head_ref }}
          commit_options: "--no-verify"
          file_pattern: "*.php"
          commit_user_name: "PHPCS Autofixer Bot"
          commit_user_email: "actions@github.com"
          commit_author: "PHPCS Autofixer Bot <actions@github.com>"
