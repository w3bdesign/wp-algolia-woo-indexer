name: PHP CodeSniffer Autofix

on:
  pull_request: # Now triggers on PRs to any branch

jobs:
  phpcs_autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # We need to fetch the PR branch to be able to push changes
          ref: ${{ github.head_ref }}

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: mbstring, xml, ctype, iconv, json # Common extensions
          tools: composer # Installs composer

      - name: Install PHP_CodeSniffer and WordPress Coding Standards
        run: |
          composer require --dev squizlabs/php_codesniffer "*"
          composer require --dev wp-coding-standards/wpcs "*"
          composer require --dev phpcompatibility/phpcompatibility-wp "*"
          # Link the WordPress coding standard to PHP_CodeSniffer
          vendor/bin/phpcs --config-set installed_paths ../../wp-coding-standards/wpcs,../../phpcompatibility/phpcompatibility-wp

      - name: Run PHPCBF to fix coding standards
        run: vendor/bin/phpcbf --standard=phpcs.xml --extensions=php .

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Apply PHPCBF fixes"
          branch: ${{ github.head_ref }}
          commit_options: "--no-verify" # Optional: Skip pre-commit hooks if any
          file_pattern: "*.php" # Only commit PHP files
          commit_user_name: "PHPCS Autofixer Bot"
          commit_user_email: "actions@github.com"
          commit_author: "PHPCS Autofixer Bot <actions@github.com>"
